<!doctype html>
<html lang="bn">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>My Task Site</title>

<style>
:root{
  --bg:#ffffff;
  --card:#f8fafc;
  --border:#e5e7eb;
  --text:#111827;
  --muted:#6b7280;
  --accent:#6366f1;
  --done:#16a34a;
  --over:#dc2626;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,Segoe UI,Roboto;
  background:var(--bg);
  color:var(--text);
}
.wrap{max-width:1100px;margin:auto;padding:24px}
h1{margin:0}
.small{font-size:12px;color:var(--muted)}
button,input,textarea,select{
  background:white;
  color:var(--text);
  border:1px solid var(--border);
  border-radius:10px;
  padding:10px 12px;
}
button{cursor:pointer}
button.primary{background:var(--accent);color:white;border:none}
.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:14px;
  padding:16px;
}
.row{display:flex;gap:10px;flex-wrap:wrap}
.task{
  border:1px solid var(--border);
  border-radius:12px;
  padding:14px;
  margin-top:12px;
}
.user-btn{padding:6px 10px;font-size:12px}
.user-done{background:var(--done);color:white;border:none}
.overdue{border-color:var(--over)}
.badge{
  display:inline-flex;
  align-items:center;
  font-size:12px;
  padding:4px 8px;
  border-radius:999px;
  border:1px solid var(--border);
  background:#fff;
  color:var(--muted);
  margin-left:6px;
}
.modal{
  position:fixed;inset:0;
  background:rgba(0,0,0,.35);
  display:none;align-items:center;justify-content:center;
  padding:14px;
}
.modal-box{
  background:white;
  border:1px solid var(--border);
  border-radius:14px;
  padding:18px;
  width:100%;
  max-width:460px;
}
hr{border:none;border-top:1px solid var(--border);margin:12px 0}
</style>
</head>

<body>

<!-- üîê LOCK SCREEN -->
<div id="lock" class="modal" style="display:flex">
  <div class="modal-box">
    <h3 style="margin-top:0">üîê Private Mode</h3>

    <div id="lockModeNew" style="display:none">
      <p class="small">‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡¶¨‡¶æ‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞: ‡¶è‡¶ï‡¶ü‡¶æ PIN ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡ßã (‡¶ï‡¶Æ‡¶™‡¶ï‡ßç‡¶∑‡ßá 4 ‡¶°‡¶ø‡¶ú‡¶ø‡¶ü)‡•§</p>
      <input id="pinNew" type="password" placeholder="New PIN" style="width:100%;margin-bottom:8px">
      <button class="primary" id="btnSetPin">Set PIN</button>
    </div>

    <div id="lockModeEnter" style="display:none">
      <p class="small">PIN ‡¶®‡¶æ ‡¶¶‡¶ø‡¶≤‡ßá ‡¶≠‡¶ø‡¶§‡¶∞‡ßá ‡¶¢‡ßã‡¶ï‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá ‡¶®‡¶æ‡•§</p>
      <input id="pinEnter" type="password" placeholder="Enter PIN" style="width:100%;margin-bottom:8px">
      <div class="row">
        <button class="primary" id="btnUnlock">Unlock</button>
        <button id="btnChangePin">Change PIN</button>
      </div>

      <div id="changePinBox" style="display:none;margin-top:10px">
        <hr>
        <p class="small">PIN change ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡ßÅ‡¶∞‡ßã‡¶®‡ßã PIN ‡¶≤‡¶æ‡¶ó‡¶¨‡ßá‡•§</p>
        <input id="pinOld" type="password" placeholder="Old PIN" style="width:100%;margin-bottom:6px">
        <input id="pinNew2" type="password" placeholder="New PIN" style="width:100%;margin-bottom:8px">
        <button class="primary" id="btnSaveNewPin">Save New PIN</button>
      </div>
    </div>

  </div>
</div>

<div class="wrap" id="app" style="display:none">

<header class="card">
  <div class="row" style="justify-content:space-between;align-items:center">
    <div>
      <h1>My Task Site</h1>
      <p class="small">Owner + Category + Points + Countdown + Reminder + Lock (LocalStorage)</p>
    </div>

    <div class="row" style="align-items:center">
      <button id="btnNotif">üîî Enable reminders</button>
      <button class="primary" onclick="openModal()">‚ûï Add Task</button>
    </div>
  </div>

  <div class="row" style="margin-top:12px">
    <div class="card">Total<br><b id="sTotal">0</b></div>
    <div class="card">Today<br><b id="sToday">0</b></div>
    <div class="card">Overdue<br><b id="sOverdue">0</b></div>
    <div class="card">Completed<br><b id="sCompleted">0</b></div>
  </div>

  <div class="row" style="margin-top:12px">
    <div class="card">üôÇ You<br>Done: <span id="hDone">0</span><br>Points: <b id="hPoints">0</b></div>
    <div class="card">üë© Wife<br>Done: <span id="wDone">0</span><br>Points: <b id="wPoints">0</b></div>
  </div>
</header>

<div class="card" style="margin-top:16px">
  <b>Tasks</b>
  <div id="tasks"></div>
</div>

</div>

<!-- ADD TASK MODAL -->
<div class="modal" id="modal">
  <div class="modal-box">
    <h3 style="margin-top:0">Add Task</h3>

    <input id="title" placeholder="Task title (required)" style="width:100%;margin-bottom:6px">
    <textarea id="notes" placeholder="Notes (optional)" style="width:100%;margin-bottom:6px"></textarea>

    <div class="row" style="margin-bottom:6px">
      <select id="owner" style="flex:1;min-width:180px">
        <option value="both" selected>üë®üë© Both (Shared)</option>
        <option value="husband">üôÇ You</option>
        <option value="wife">üë© Wife</option>
      </select>

      <!-- ‚úÖ CATEGORY (dynamic + add new) -->
      <select id="category" style="flex:1;min-width:180px"></select>
    </div>

    <!-- ‚úÖ Add new category box -->
    <div id="newCategoryBox" style="display:none;margin-bottom:6px">
      <input id="newCategoryInput" placeholder="New category name" style="width:100%">
      <div class="row" style="margin-top:6px">
        <button class="primary" id="btnAddCategory">Add Category</button>
        <button id="btnCancelCategory">Cancel</button>
      </div>
    </div>

    <input id="due" type="datetime-local" style="width:100%;margin-bottom:8px">

    <label class="small" style="display:flex;gap:8px;align-items:center;margin-bottom:10px">
      <input type="checkbox" id="reminder">
      Smart reminder (30 / 10 / 5 min ‡¶Ü‡¶ó‡ßá)
    </label>

    <div class="row">
      <button class="primary" id="btnSaveTask">Save</button>
      <button id="btnCancelTask">Cancel</button>
    </div>
  </div>
</div>

<script>
/* =========================
   STORAGE KEYS
========================= */
const PIN_KEY = "site_pin_v1";
const POINTS_KEY = "points";
const STORAGE_NEW = "couple_tasks_all_v1";

/* ‚úÖ Categories key */
const CAT_KEY = "couple_categories_v1";
const DEFAULT_CATEGORIES = ["General","Home","Work","Personal","Health"];

// Old keys (migration attempt)
const STORAGE_OLD_KEYS = [
  "couple_tasks_OWNER",
  "couple_tasks_FINAL_MERGED",
  "couple_tasks_STABLE",
  "couple_tasks_white",
  "couple_tasks_final",
  "couple_tasks_v2",
  "couple_tasks_v1",
  "couple_tasks_FULL"
];

/* =========================
   DOM BINDING
========================= */
const lock = document.getElementById("lock");
const app = document.getElementById("app");

const lockModeNew = document.getElementById("lockModeNew");
const lockModeEnter = document.getElementById("lockModeEnter");
const changePinBox = document.getElementById("changePinBox");

const pinNew = document.getElementById("pinNew");
const pinEnter = document.getElementById("pinEnter");
const pinOld = document.getElementById("pinOld");
const pinNew2 = document.getElementById("pinNew2");

const btnSetPin = document.getElementById("btnSetPin");
const btnUnlock = document.getElementById("btnUnlock");
const btnChangePin = document.getElementById("btnChangePin");
const btnSaveNewPin = document.getElementById("btnSaveNewPin");

const btnNotif = document.getElementById("btnNotif");

const modal = document.getElementById("modal");
const btnSaveTask = document.getElementById("btnSaveTask");
const btnCancelTask = document.getElementById("btnCancelTask");

const titleInput = document.getElementById("title");
const notesInput = document.getElementById("notes");
const ownerSelect = document.getElementById("owner");
const categorySelect = document.getElementById("category");
const dueInput = document.getElementById("due");
const reminderInput = document.getElementById("reminder");

const newCategoryBox = document.getElementById("newCategoryBox");
const newCategoryInput = document.getElementById("newCategoryInput");
const btnAddCategory = document.getElementById("btnAddCategory");
const btnCancelCategory = document.getElementById("btnCancelCategory");

const tasksDiv = document.getElementById("tasks");

const sTotal = document.getElementById("sTotal");
const sToday = document.getElementById("sToday");
const sOverdue = document.getElementById("sOverdue");
const sCompleted = document.getElementById("sCompleted");
const hDone = document.getElementById("hDone");
const wDone = document.getElementById("wDone");
const hPoints = document.getElementById("hPoints");
const wPoints = document.getElementById("wPoints");

/* =========================
   DATA
========================= */
let tasks = [];
let points = { husband: 0, wife: 0 };

/* ‚úÖ categories list */
let categories = [];

function loadPoints(){
  try{
    const p = JSON.parse(localStorage.getItem(POINTS_KEY) || '{"husband":0,"wife":0}');
    points = { husband: Number(p.husband||0), wife: Number(p.wife||0) };
  }catch{
    points = { husband:0, wife:0 };
  }
}
function savePoints(){
  localStorage.setItem(POINTS_KEY, JSON.stringify(points));
}

function loadCategories(){
  try{
    const raw = localStorage.getItem(CAT_KEY);
    if(raw){
      const arr = JSON.parse(raw);
      if(Array.isArray(arr) && arr.length){
        categories = arr.map(x=>String(x)).filter(Boolean);
      }else{
        categories = [...DEFAULT_CATEGORIES];
      }
    }else{
      categories = [...DEFAULT_CATEGORIES];
    }
  }catch{
    categories = [...DEFAULT_CATEGORIES];
  }

  // Deduplicate
  categories = Array.from(new Set(categories));
  saveCategories();
}

function saveCategories(){
  localStorage.setItem(CAT_KEY, JSON.stringify(categories));
}

function ensureCategoryExists(cat){
  const c = (cat || "").trim();
  if(!c) return "General";
  if(!categories.includes(c)){
    categories.push(c);
    categories = Array.from(new Set(categories));
    saveCategories();
  }
  return c;
}

function renderCategoriesDropdown(){
  const current = categorySelect.value || "General";

  categorySelect.innerHTML = "";
  categories.forEach(c=>{
    const opt = document.createElement("option");
    opt.value = c;
    opt.textContent = c;
    categorySelect.appendChild(opt);
  });

  const addOpt = document.createElement("option");
  addOpt.value = "__add__";
  addOpt.textContent = "‚ûï Add new category";
  categorySelect.appendChild(addOpt);

  // Restore selection if possible
  if(categories.includes(current)) categorySelect.value = current;
  else categorySelect.value = "General";
}

categorySelect.addEventListener("change", ()=>{
  if(categorySelect.value === "__add__"){
    newCategoryBox.style.display = "block";
    newCategoryInput.focus();
  }else{
    newCategoryBox.style.display = "none";
  }
});

btnAddCategory.addEventListener("click", ()=>{
  const name = (newCategoryInput.value || "").trim();
  if(!name) return alert("Category name ‡¶≤‡¶ø‡¶ñ‡ßã");
  if(categories.includes(name)) return alert("Already exists");
  categories.push(name);
  categories = Array.from(new Set(categories));
  saveCategories();

  newCategoryInput.value = "";
  newCategoryBox.style.display = "none";
  renderCategoriesDropdown();
  categorySelect.value = name;
});

btnCancelCategory.addEventListener("click", ()=>{
  newCategoryInput.value = "";
  newCategoryBox.style.display = "none";
  // fallback selection
  categorySelect.value = "General";
});

function normalizeTask(t){
  const nt = {...t};
  if(!nt.id) nt.id = Date.now() + Math.floor(Math.random()*999);
  if(!nt.title) nt.title = "(no title)";
  if(!nt.notes) nt.notes = "";
  if(!nt.owner) nt.owner = "both";

  // ‚úÖ category normalize + make sure it exists in categories list
  nt.category = ensureCategoryExists(nt.category || "General");

  if(!nt.due) nt.due = "";
  if(typeof nt.reminder !== "boolean") nt.reminder = false;

  if(!nt.completedBy) nt.completedBy = {husband:false, wife:false};
  if(typeof nt.completedBy.husband !== "boolean") nt.completedBy.husband = !!nt.completedBy.husband;
  if(typeof nt.completedBy.wife !== "boolean") nt.completedBy.wife = !!nt.completedBy.wife;

  if(!nt.reminderSent) nt.reminderSent = {m30:false, m10:false, m5:false, overdue:false};

  return nt;
}

function loadTasks(){
  let loaded = null;

  // 1) new key
  try{
    const raw = localStorage.getItem(STORAGE_NEW);
    if(raw) loaded = JSON.parse(raw);
  }catch{}

  // 2) migration from older keys if needed
  if(!Array.isArray(loaded) || loaded.length === 0){
    for(const k of STORAGE_OLD_KEYS){
      try{
        const raw = localStorage.getItem(k);
        if(!raw) continue;
        const arr = JSON.parse(raw);
        if(Array.isArray(arr) && arr.length){
          loaded = arr;
          break;
        }
      }catch{}
    }
  }

  tasks = Array.isArray(loaded) ? loaded.map(normalizeTask) : [];
  saveTasks();
}

function saveTasks(){
  localStorage.setItem(STORAGE_NEW, JSON.stringify(tasks));
}

function saveAll(){
  saveTasks();
  savePoints();
}

/* =========================
   LOCK (PIN)
========================= */
function showLock(){
  lock.style.display = "flex";
  app.style.display = "none";
}

function showApp(){
  lock.style.display = "none";
  app.style.display = "block";
  render();
}

function initLock(){
  const pin = localStorage.getItem(PIN_KEY);
  showLock();
  changePinBox.style.display = "none";

  if(!pin){
    lockModeNew.style.display = "block";
    lockModeEnter.style.display = "none";
  }else{
    lockModeNew.style.display = "none";
    lockModeEnter.style.display = "block";
  }
}

btnSetPin.addEventListener("click", ()=>{
  const v = (pinNew.value || "").trim();
  if(v.length < 4) return alert("PIN ‡¶ï‡¶Æ‡¶™‡¶ï‡ßç‡¶∑‡ßá 4 digit ‡¶¶‡¶æ‡¶ì‡•§");
  localStorage.setItem(PIN_KEY, v);
  pinNew.value = "";
  initLock();
  alert("PIN ‡¶∏‡ßá‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§ ‡¶è‡¶ñ‡¶® Unlock ‡¶ï‡¶∞‡ßã‡•§");
});

btnUnlock.addEventListener("click", ()=>{
  const pin = localStorage.getItem(PIN_KEY);
  const v = (pinEnter.value || "").trim();
  if(v === pin){
    pinEnter.value = "";
    showApp();
  }else{
    alert("Wrong PIN");
  }
});

btnChangePin.addEventListener("click", ()=>{
  changePinBox.style.display = (changePinBox.style.display === "none") ? "block" : "none";
});

btnSaveNewPin.addEventListener("click", ()=>{
  const pin = localStorage.getItem(PIN_KEY);
  const oldv = (pinOld.value || "").trim();
  const newv = (pinNew2.value || "").trim();
  if(oldv !== pin) return alert("Old PIN ‡¶≠‡ßÅ‡¶≤‡•§");
  if(newv.length < 4) return alert("New PIN ‡¶ï‡¶Æ‡¶™‡¶ï‡ßç‡¶∑‡ßá 4 digit ‡¶¶‡¶æ‡¶ì‡•§");
  localStorage.setItem(PIN_KEY, newv);
  pinOld.value = ""; pinNew2.value = "";
  changePinBox.style.display = "none";
  alert("PIN updated. ‡¶è‡¶ñ‡¶® ‡¶®‡¶§‡ßÅ‡¶® PIN ‡¶¶‡¶ø‡ßü‡ßá Unlock ‡¶ï‡¶∞‡ßã‡•§");
  initLock();
});

/* =========================
   MODAL
========================= */
function openModal(){ modal.style.display = "flex"; }
function closeModal(){ modal.style.display = "none"; }

btnCancelTask.addEventListener("click", closeModal);

btnSaveTask.addEventListener("click", ()=>{
  saveTask();
});

function resetModal(){
  titleInput.value = "";
  notesInput.value = "";
  ownerSelect.value = "both";
  // keep category selected if user wants; but ensure not __add__
  if(categorySelect.value === "__add__") categorySelect.value = "General";
  dueInput.value = "";
  reminderInput.checked = false;
  newCategoryInput.value = "";
  newCategoryBox.style.display = "none";
}

function saveTask(){
  const title = (titleInput.value || "").trim();
  if(!title) return alert("Task title ‡¶¶‡¶∞‡¶ï‡¶æ‡¶∞‡•§");

  // If user selected add-new option but didn't add
  if(categorySelect.value === "__add__"){
    newCategoryBox.style.display = "block";
    return alert("‡¶®‡¶§‡ßÅ‡¶® category ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßã ‡¶¨‡¶æ ‡¶Ö‡¶®‡ßç‡¶Ø category select ‡¶ï‡¶∞‡ßã‡•§");
  }

  const t = normalizeTask({
    id: Date.now(),
    title,
    notes: (notesInput.value || "").trim(),
    owner: ownerSelect.value,
    category: categorySelect.value,
    due: dueInput.value,
    reminder: !!reminderInput.checked,
    completedBy: {husband:false, wife:false},
    reminderSent: {m30:false, m10:false, m5:false, overdue:false}
  });

  tasks.unshift(t);
  saveTasks();

  resetModal();
  closeModal();
  render();
}

/* =========================
   HELPERS
========================= */
function friendlyDate(d){
  return new Date(d).toLocaleString("en-US",{dateStyle:"medium",timeStyle:"short"});
}
function remainingTime(d){
  const diff = new Date(d) - new Date();
  const min = Math.round(diff/60000);
  if(min < 0) return `‚õî Overdue by ${Math.abs(min)} min`;
  if(min < 60) return `‚è≥ Remaining ${min} min`;
  return `‚è≥ Remaining ${Math.floor(min/60)} hr ${min%60} min`;
}
function ownerBadge(owner){
  if(owner==="husband") return `<span class="badge">üôÇ You</span>`;
  if(owner==="wife") return `<span class="badge">üë© Wife</span>`;
  return `<span class="badge">üë®üë© Shared</span>`;
}
function categoryBadge(cat){
  return `<span class="badge">${cat}</span>`;
}

function isCompleted(t){
  if(t.owner==="both") return t.completedBy.husband && t.completedBy.wife;
  if(t.owner==="husband") return t.completedBy.husband;
  if(t.owner==="wife") return t.completedBy.wife;
  return false;
}
function isOverdue(t){
  if(!t.due) return false;
  if(isCompleted(t)) return false;
  const due = new Date(t.due);
  return due < new Date();
}

/* =========================
   TOGGLE + POINTS
========================= */
function toggleUser(id,user){
  const t = tasks.find(x=>x.id===id);
  if(!t) return;

  if(t.owner==="husband" && user!=="husband") return;
  if(t.owner==="wife" && user!=="wife") return;

  if(!t.completedBy[user]){
    t.completedBy[user] = true;
    points[user] += 10;
  }else{
    t.completedBy[user] = false;
    points[user] -= 10;
  }

  saveAll();
  render();
}

/* =========================
   STATS
========================= */
function updateStats(){
  sTotal.textContent = tasks.length;
  sToday.textContent = tasks.filter(t=>t.due && new Date(t.due).toDateString()===new Date().toDateString()).length;
  sOverdue.textContent = tasks.filter(t=>isOverdue(t)).length;
  sCompleted.textContent = tasks.filter(t=>isCompleted(t)).length;

  hDone.textContent = tasks.filter(t=>{
    if(t.owner==="husband") return t.completedBy.husband;
    if(t.owner==="both") return t.completedBy.husband;
    return false;
  }).length;

  wDone.textContent = tasks.filter(t=>{
    if(t.owner==="wife") return t.completedBy.wife;
    if(t.owner==="both") return t.completedBy.wife;
    return false;
  }).length;

  hPoints.textContent = points.husband;
  wPoints.textContent = points.wife;
}

/* =========================
   REMINDERS
========================= */
function ensureNotificationPermission(){
  if(!("Notification" in window)){
    alert("‡¶è‡¶á ‡¶¨‡ßç‡¶∞‡¶æ‡¶â‡¶ú‡¶æ‡¶∞‡ßá Notification ‡¶∏‡¶æ‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶®‡ßá‡¶á‡•§");
    return;
  }
  Notification.requestPermission().then(p=>{
    if(p==="granted"){
      alert("Reminders enabled ‚úÖ");
    }else{
      alert("Notification blocked. Browser settings ‡¶•‡ßá‡¶ï‡ßá Allow ‡¶ï‡¶∞‡¶§‡ßá ‡¶π‡¶¨‡ßá‡•§");
    }
  });
}
btnNotif.addEventListener("click", ensureNotificationPermission);

function maybeNotify(t, key, text){
  if(!t.reminderSent) t.reminderSent = {m30:false,m10:false,m5:false,overdue:false};
  if(t.reminderSent[key]) return false;

  new Notification("üîî Task Reminder", { body: text });
  t.reminderSent[key] = true;
  return true;
}

function checkReminders(){
  if(!("Notification" in window)) return;
  if(Notification.permission !== "granted") return;

  const now = new Date();
  let changed = false;

  for(const t of tasks){
    if(!t.reminder) continue;
    if(!t.due) continue;
    if(isCompleted(t)) continue;

    const due = new Date(t.due);
    const min = Math.round((due - now)/60000);

    if(min <= 30 && min >= 29){
      changed = maybeNotify(t, "m30", `${t.title} ‚Äî 30 minutes left`) || changed;
    }
    if(min <= 10 && min >= 9){
      changed = maybeNotify(t, "m10", `${t.title} ‚Äî 10 minutes left`) || changed;
    }
    if(min <= 5 && min >= 4){
      changed = maybeNotify(t, "m5", `${t.title} ‚Äî 5 minutes left`) || changed;
    }

    if(min < 0){
      if(!t.reminderSent.overdue){
        changed = maybeNotify(t, "overdue", `${t.title} ‚Äî Overdue`) || changed;
      }
    }
  }

  if(changed) saveTasks();
}

/* =========================
   RENDER
========================= */
function render(){
  tasksDiv.innerHTML = "";

  for(const t of tasks){
    const overdue = isOverdue(t);

    const showH = (t.owner==="both" || t.owner==="husband");
    const showW = (t.owner==="both" || t.owner==="wife");

    tasksDiv.innerHTML += `
      <div class="task ${overdue ? "overdue" : ""}">
        <div>
          <b>${t.title}</b>
          ${ownerBadge(t.owner)}
          ${categoryBadge(t.category)}
        </div>

        ${t.notes ? `<div class="small">${t.notes}</div>` : ""}

        <div class="small">üïí ${t.due ? friendlyDate(t.due) : "No expiry"}</div>
        ${t.due ? `<div class="small">${remainingTime(t.due)}</div>` : ""}

        <div class="row" style="margin-top:8px">
          ${showH ? `
            <button class="user-btn ${t.completedBy.husband ? "user-done" : ""}"
              onclick="toggleUser(${t.id},'husband')">üôÇ ${t.completedBy.husband ? "Done" : "Pending"}</button>
          ` : ""}

          ${showW ? `
            <button class="user-btn ${t.completedBy.wife ? "user-done" : ""}"
              onclick="toggleUser(${t.id},'wife')">üë© ${t.completedBy.wife ? "Done" : "Pending"}</button>
          ` : ""}
        </div>

        ${t.reminder ? `<div class="small">üîî Reminder: ON</div>` : `<div class="small">üîï Reminder: OFF</div>`}
      </div>
    `;
  }

  updateStats();
}

/* =========================
   INIT
========================= */
loadPoints();
loadCategories();
renderCategoriesDropdown();
loadTasks();             // normalizeTask will also ensureCategoryExists for any old tasks
renderCategoriesDropdown(); // refresh in case tasks introduced new categories
initLock();

// Keep countdown + reminders fresh
setInterval(()=>{ if(app.style.display==="block") render(); }, 60000);
setInterval(()=>{ if(app.style.display==="block") checkReminders(); }, 60000);
</script>

</body>
</html>
